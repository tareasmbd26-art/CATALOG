<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Mi Tienda ¬∑ Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f5f7fb; display: flex; flex-direction: column; align-items: center; }
        .app-container { max-width: 480px; width: 100%; background: white; min-height: 100vh; position: relative; }
        .screen { display: none; padding: 16px 16px 80px; }
        .active-screen { display: block; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; border-bottom: 1px solid #f0f2f5; }
        .logo-area { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .logo-icon { background: linear-gradient(145deg, #1a5cff, #0a3eb0); color: white; width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .logo-text { font-weight: 700; font-size: 18px; color: #0b1b33; }
        .header-actions { display: flex; gap: 16px; }
        .icon-btn { font-size: 20px; cursor: pointer; position: relative; }
        .notification-badge { position: absolute; top: -4px; right: -4px; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; }
        .btn { padding: 12px 20px; background: #1a5cff; color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-success { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }
        .btn-outline { background: white; border: 2px solid #1a5cff; color: #1a5cff; }
        .producto-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #e9ecf0; display: flex; gap: 16px; }
        .producto-emoji { width: 64px; height: 64px; background: #f0f2f5; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .producto-info { flex: 1; }
        .producto-nombre { font-weight: 600; font-size: 16px; }
        .producto-precio { font-size: 18px; font-weight: 700; color: #1a5cff; }
        .producto-stock { font-size: 13px; color: #2ecc71; }
        .list-card { background: white; border-radius: 20px; border: 1px solid #f0f2f5; margin-bottom: 16px; }
        .list-item { display: flex; justify-content: space-between; padding: 16px; border-bottom: 1px solid #f5f7fb; }
        
        /* MODAL FIX: Added cursor pointer and proper overlay handling */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 24px; max-width: 400px; width: 90%; position: relative; }
        
        /* CLOSE BUTTON STYLE */
        .close-modal-btn { position: absolute; top: 16px; right: 16px; background: #f0f2f5; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; color: #666; }
        
        .form-input { width: 100%; padding: 14px; border: 2px solid #e9ecf0; border-radius: 14px; margin-bottom: 16px; }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; border-top: 1px solid #e9ecf0; display: flex; padding: 8px 0; z-index: 500; }
        .nav-item { display: flex; flex-direction: column; align-items: center; flex: 1; padding: 8px; cursor: pointer; color: #8a92a3; }
        .nav-item.active { color: #1a5cff; }
        .nav-icon { font-size: 22px; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 30px; z-index: 3000; font-size: 14px; text-align: center; min-width: 200px; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="logo-area" onclick="cambiarNombreTienda()">
                <div class="logo-icon">üè™</div>
                <div class="logo-text" id="businessNameDisplay">Mi Tienda</div>
            </div>
            <div class="header-actions">
                <span class="icon-btn" onclick="verNotificaciones()">
                    üîî
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </span>
            </div>
        </div>

        <div id="catalogo-screen" class="screen active-screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="font-size: 24px;">üì± Cat√°logo</h1>
                <button class="btn-small" onclick="abrirModalProducto()">+ Agregar</button>
            </div>

            <div style="background: #f2f6ff; border-radius: 20px; padding: 20px; margin-bottom: 24px; border: 2px solid #1a5cff;">
                <div style="font-weight: 700; margin-bottom: 12px;">üåê LINK DE TU TIENDA:</div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="catalogLink" readonly value="cargando..." style="flex: 1; padding: 14px; border: 1px solid #ccc; border-radius: 12px; background: white;">
                    <button class="btn-small" onclick="copiarLink()" style="background: #1a5cff; color: white;">üìã Copiar</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-small" onclick="compartirWhatsApp()" style="background: #25D366; color: white; flex: 1;">üì≤ WhatsApp</button>
                    <button class="btn-small" onclick="compartirFacebook()" style="background: #1877F2; color: white; flex: 1;">üìò Facebook</button>
                </div>
            </div>

            <h2 style="font-size: 18px; margin-bottom: 12px;">Tus productos</h2>
            <div id="productosLista"></div>
            <div id="productosEmpty" style="display: none; text-align: center; padding: 40px; color: #999;">No hay productos</div>
        </div>

        <div id="pedidos-screen" class="screen">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <span style="font-size: 28px; cursor: pointer;" onclick="showScreen('catalogo-screen')">‚Üê</span>
                <h1 style="font-size: 24px;">üõí Pedidos</h1>
            </div>
            <div id="pedidosLista">Cargando...</div>
        </div>

        <div id="ventas-screen" class="screen">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <span style="font-size: 28px; cursor: pointer;" onclick="showScreen('catalogo-screen')">‚Üê</span>
                <h1 style="font-size: 24px;">üí∞ Ventas</h1>
            </div>
            <div id="ventasLista">Cargando...</div>
        </div>

        <div id="clientes-screen" class="screen">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <span style="font-size: 28px; cursor: pointer;" onclick="showScreen('catalogo-screen')">‚Üê</span>
                <h1 style="font-size: 24px;">üë• Clientes</h1>
            </div>
            <div id="clientesLista">Cargando...</div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('catalogo-screen')">üì±<span>Cat√°logo</span></div>
            <div class="nav-item" onclick="showScreen('pedidos-screen')">üõí<span>Pedidos</span></div>
            <div class="nav-item" onclick="showScreen('ventas-screen')">üí∞<span>Ventas</span></div>
            <div class="nav-item" onclick="showScreen('clientes-screen')">üë•<span>Clientes</span></div>
        </div>

        <div id="productoModal" class="modal" onclick="cerrarModalFuera(event)">
            <div class="modal-content">
                <div class="close-modal-btn" onclick="cerrarModal()">‚úï</div>
                
                <h2 id="modalTitulo" style="margin-bottom: 16px;">‚ûï Agregar producto</h2>
                <input type="text" id="productoNombre" class="form-input" placeholder="Nombre (Ej: Pan) *" autocomplete="off">
                <input type="text" id="productoDescripcion" class="form-input" placeholder="Descripci√≥n (Opcional)" autocomplete="off">
                <input type="number" id="productoPrecio" class="form-input" placeholder="Precio (Ej: 1.50) *" step="0.01">
                <input type="number" id="productoStock" class="form-input" placeholder="Stock (Cantidad) *">
                <input type="text" id="productoEmoji" class="form-input" placeholder="Emoji (Ej: ü•ñ)" maxlength="2">
                <button class="btn" onclick="guardarProducto()" style="width: 100%;">Guardar producto</button>
            </div>
        </div>

        <div id="confirmarModal" class="modal" onclick="cerrarModalFuera(event)">
            <div class="modal-content">
                <div class="close-modal-btn" onclick="cerrarModal()">‚úï</div>
                <h2 style="margin-bottom: 16px;">‚úÖ Confirmar pedido</h2>
                <div id="confirmarInfo" style="background: #f2f6ff; padding: 16px; border-radius: 12px; margin-bottom: 16px;"></div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="btnPagoCompleto" class="btn-success" style="flex: 1; padding: 12px; border: none; border-radius: 12px;" onclick="seleccionarPago(true)">‚úÖ Completo</button>
                    <button id="btnPagoParcial" class="btn-outline" style="flex: 1; padding: 12px; border: 2px solid #1a5cff; border-radius: 12px; background: white;" onclick="seleccionarPago(false)">üîÑ 2 cuotas</button>
                </div>
                <button class="btn" onclick="confirmarPedido()" style="width: 100%;">Confirmar pedido</button>
            </div>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        const STORAGE_PRODUCTOS = 'catalogo_productos';
        const STORAGE_PEDIDOS = 'pedidos_pendientes';
        const STORAGE_VENTAS = 'ventas_registradas';
        const STORAGE_CLIENTES = 'clientes_registrados';
        
        let productoEditandoId = null;
        let pedidoSeleccionado = null;
        let pagoEsCompleto = true;

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin iniciado');
            
            if (!localStorage.getItem(STORAGE_PRODUCTOS)) {
                const productosIniciales = [
                    { id: 1, nombre: "Pan franc√©s", descripcion: "Pan fresco del d√≠a", precio: 2.50, stock: 98, emoji: "ü•ñ" },
                    { id: 2, nombre: "Pastel de fresa", descripcion: "Delicioso pastel casero", precio: 15.00, stock: 23, emoji: "üç∞" }
                ];
                localStorage.setItem(STORAGE_PRODUCTOS, JSON.stringify(productosIniciales));
            }
            if (!localStorage.getItem(STORAGE_PEDIDOS)) localStorage.setItem(STORAGE_PEDIDOS, '[]');
            if (!localStorage.getItem(STORAGE_VENTAS)) localStorage.setItem(STORAGE_VENTAS, '[]');
            if (!localStorage.getItem(STORAGE_CLIENTES)) localStorage.setItem(STORAGE_CLIENTES, '[]');
            
            // Cargar nombre de negocio guardado
            const storedName = localStorage.getItem('businessName');
            if(storedName) {
                document.querySelectorAll('#businessNameDisplay').forEach(el => el.textContent = storedName);
            }

            actualizarLink();
            actualizarCatalogo();
            actualizarPedidos();
            actualizarVentas();
            actualizarClientes();
            actualizarNotificaciones();
            
            window.addEventListener('storage', function(e) {
                if (e.key === STORAGE_PEDIDOS) {
                    actualizarPedidos();
                    actualizarNotificaciones();
                }
            });
        });

        // ========== FUNCIONES DE MODAL (NUEVAS) ==========
        function cerrarModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        function cerrarModalFuera(event) {
            if (event.target.classList.contains('modal')) {
                cerrarModal();
            }
        }

        // ========== LINK DEL CAT√ÅLOGO ==========
        function actualizarLink() {
            const link = 'https://tareasmbd26-art.github.io/CATALOG/tienda.html';
            localStorage.setItem('catalogLink', link);
            const input = document.getElementById('catalogLink');
            if (input) input.value = link;
        }
        
        function copiarLink() { 
            let link = document.getElementById('catalogLink');
            if (link) {
                link.select(); 
                document.execCommand('copy'); 
                toast('üìã Link copiado');
            }
        }
        
        function compartirWhatsApp() { 
            let link = document.getElementById('catalogLink')?.value || localStorage.getItem('catalogLink');
            let nombre = localStorage.getItem('businessName') || 'Mi Tienda';
            window.open(`https://wa.me/?text=${encodeURIComponent(`üõçÔ∏è ${nombre}\nüîó ${link}`)}`, '_blank');
        }
        
        function compartirFacebook() {
            let link = document.getElementById('catalogLink')?.value || localStorage.getItem('catalogLink');
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
        }

        // ========== CAT√ÅLOGO ==========
        function actualizarCatalogo() {
            let productos = JSON.parse(localStorage.getItem(STORAGE_PRODUCTOS)) || [];
            let container = document.getElementById('productosLista');
            let emptyMsg = document.getElementById('productosEmpty');
            
            if (!container) return;
            
            if (productos.length === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            let html = '';
            // Ordenar por ID descendente para ver los nuevos primero
            productos.sort((a,b) => b.id - a.id).forEach(p => {
                html += `<div class="producto-card">
                    <div class="producto-emoji">${p.emoji || 'üì¶'}</div>
                    <div class="producto-info">
                        <div class="producto-nombre">${p.nombre}</div>
                        <div style="color: #666; font-size: 13px;">${p.descripcion || ''}</div>
                        <div class="producto-precio">$${parseFloat(p.precio).toFixed(2)}</div>
                        <div class="producto-stock">üì¶ Stock: ${p.stock} uds</div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="btn-small" style="background: #f39c12; color: white; border: none;" onclick="editarProducto(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn-small" style="background: #e74c3c; color: white; border: none;" onclick="eliminarProducto(${p.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }
        
        function abrirModalProducto() {
            productoEditandoId = null;
            document.getElementById('modalTitulo').innerText = '‚ûï Agregar producto';
            document.getElementById('productoNombre').value = '';
            document.getElementById('productoDescripcion').value = '';
            document.getElementById('productoPrecio').value = '';
            document.getElementById('productoStock').value = '';
            document.getElementById('productoEmoji').value = '';
            document.getElementById('productoModal').classList.add('active');
        }
        
        function editarProducto(id) {
            let productos = JSON.parse(localStorage.getItem(STORAGE_PRODUCTOS)) || [];
            let p = productos.find(p => p.id === id);
            if (!p) return;
            
            productoEditandoId = id;
            document.getElementById('modalTitulo').innerText = '‚úèÔ∏è Editar producto';
            document.getElementById('productoNombre').value = p.nombre;
            document.getElementById('productoDescripcion').value = p.descripcion || '';
            document.getElementById('productoPrecio').value = p.precio;
            document.getElementById('productoStock').value = p.stock;
            document.getElementById('productoEmoji').value = p.emoji || '';
            document.getElementById('productoModal').classList.add('active');
        }
        
        function eliminarProducto(id) {
            if (!confirm('¬øEliminar este producto?')) return;
            let productos = JSON.parse(localStorage.getItem(STORAGE_PRODUCTOS)) || [];
            productos = productos.filter(p => p.id !== id);
            localStorage.setItem(STORAGE_PRODUCTOS, JSON.stringify(productos));
            actualizarCatalogo();
            localStorage.setItem('catalogo_actualizado', Date.now());
            toast('üóëÔ∏è Producto eliminado');
        }
        
        function guardarProducto() {
            let nombre = document.getElementById('productoNombre').value.trim();
            let precioStr = document.getElementById('productoPrecio').value;
            let stockStr = document.getElementById('productoStock').value;
            let emoji = document.getElementById('productoEmoji').value.trim();
            
            // Validaci√≥n mejorada
            if (!nombre) { toast('‚ö†Ô∏è Falta el nombre'); return; }
            if (!precioStr) { toast('‚ö†Ô∏è Falta el precio'); return; }
            if (!stockStr) { toast('‚ö†Ô∏è Falta el stock'); return; }

            let precio = parseFloat(precioStr);
            let stock = parseInt(stockStr);

            if (isNaN(precio)) { toast('‚ö†Ô∏è Precio inv√°lido'); return; }
            if (isNaN(stock)) { toast('‚ö†Ô∏è Stock inv√°lido'); return; }

            let productos = JSON.parse(localStorage.getItem(STORAGE_PRODUCTOS)) || [];
            
            let producto = {
                id: productoEditandoId || Date.now(),
                nombre: nombre,
                descripcion: document.getElementById('productoDescripcion').value.trim() || 'Sin descripci√≥n',
                precio: precio,
                stock: stock,
                emoji: emoji || 'üì¶'
            };
            
            if (productoEditandoId) {
                let index = productos.findIndex(p => p.id === productoEditandoId);
                if (index !== -1) {
                    productos[index] = producto;
                }
            } else {
                productos.push(producto);
            }
            
            localStorage.setItem(STORAGE_PRODUCTOS, JSON.stringify(productos));
            actualizarCatalogo();
            cerrarModal(); // Usamos la nueva funci√≥n
            
            localStorage.setItem('catalogo_actualizado', Date.now());
            toast(productoEditandoId ? '‚úÖ Producto actualizado' : '‚úÖ Producto agregado');
        }

        // ========== PEDIDOS ==========
        function actualizarPedidos() {
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            let pendientes = pedidos.filter(p => p.estado === 'pendiente');
            let container = document.getElementById('pedidosLista');
            
            if (!container) return;
            
            if (pendientes.length === 0) {
                container.innerHTML = '<div class="list-item">‚úÖ No hay pedidos pendientes</div>';
                return;
            }
            
            let html = '';
            pendientes.forEach(p => {
                html += `<div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 2px solid #f39c12;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 700;">${p.producto.emoji} ${p.producto.nombre}</span>
                        <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">NUEVO</span>
                    </div>
                    <div style="font-size: 14px; margin-bottom: 12px;">
                        üë§ ${p.cliente}<br>
                        üì± ${p.telefono}
                    </div>
                    <div style="background: #f2f6ff; padding: 12px; border-radius: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>üí∞ Total:</span>
                            <span style="font-weight: 700;">$${p.total.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>üí≥ Pago:</span>
                            <span>${p.cuotas} cuota(s) ¬∑ $${p.montoPorCuota.toFixed(2)} c/u</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-success" style="flex:1; padding: 12px; border: none; border-radius: 12px; font-weight: 600;" onclick="abrirConfirmarPedido(${p.id})">‚úÖ Confirmar</button>
                        <button class="btn-danger" style="flex:1; padding: 12px; border: none; border-radius: 12px; font-weight: 600;" onclick="rechazarPedido(${p.id})">‚ùå Rechazar</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
            actualizarNotificaciones();
        }
        
        function abrirConfirmarPedido(id) {
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            pedidoSeleccionado = pedidos.find(p => p.id === id && p.estado === 'pendiente');
            if (!pedidoSeleccionado) return;
            
            document.getElementById('confirmarInfo').innerHTML = `
                <div style="font-weight: 700; font-size: 16px;">${pedidoSeleccionado.producto.emoji} ${pedidoSeleccionado.producto.nombre}</div>
                <div style="color: #666; margin-top: 4px;">${pedidoSeleccionado.cliente} ¬∑ ${pedidoSeleccionado.telefono}</div>
                <div style="margin-top: 12px; display: flex; justify-content: space-between;">
                    <span>üí∞ Total:</span>
                    <span style="font-weight: 700;">$${pedidoSeleccionado.total.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>üí≥ Solicit√≥:</span>
                    <span>${pedidoSeleccionado.cuotas} cuota(s)</span>
                </div>
            `;
            
            seleccionarPago(true);
            document.getElementById('confirmarModal').classList.add('active');
        }
        
        function seleccionarPago(completo) {
            pagoEsCompleto = completo;
            let btnCompleto = document.getElementById('btnPagoCompleto');
            let btnParcial = document.getElementById('btnPagoParcial');
            
            if (completo) {
                btnCompleto.className = 'btn-success';
                btnCompleto.style.cssText = 'flex:1; padding:12px; border:none; border-radius:12px; background:#2ecc71; color:white; font-weight:600;';
                btnParcial.className = 'btn-outline';
                btnParcial.style.cssText = 'flex:1; padding:12px; border:2px solid #1a5cff; border-radius:12px; background:white; color:#1a5cff; font-weight:600;';
            } else {
                btnCompleto.className = 'btn-outline';
                btnCompleto.style.cssText = 'flex:1; padding:12px; border:2px solid #1a5cff; border-radius:12px; background:white; color:#1a5cff; font-weight:600;';
                btnParcial.className = 'btn-success';
                btnParcial.style.cssText = 'flex:1; padding:12px; border:none; border-radius:12px; background:#2ecc71; color:white; font-weight:600;';
            }
        }
        
        function confirmarPedido() {
            if (!pedidoSeleccionado) return;
            
            let productos = JSON.parse(localStorage.getItem(STORAGE_PRODUCTOS)) || [];
            let producto = productos.find(p => p.id === pedidoSeleccionado.producto.id);
            
            // Verificaci√≥n segura de producto eliminado
            if (!producto) {
                toast('‚ö†Ô∏è El producto ya no existe en el cat√°logo');
                // A√∫n as√≠ permitimos procesarlo? Mejor no, para evitar errores
                return;
            }
            
            if (producto.stock < 1) {
                toast('‚ùå Stock insuficiente');
                return;
            }
            
            // Restar stock
            producto.stock -= 1;
            localStorage.setItem(STORAGE_PRODUCTOS, JSON.stringify(productos));
            actualizarCatalogo();
            
            // Actualizar pedido
            pedidoSeleccionado.estado = 'aceptado';
            pedidoSeleccionado.pagoCompleto = pagoEsCompleto;
            pedidoSeleccionado.fechaConfirmacion = new Date().toISOString();
            
            // Crear venta
            let venta = {
                id: Date.now(),
                fecha: pedidoSeleccionado.fechaConfirmacion,
                cliente: pedidoSeleccionado.cliente,
                telefono: pedidoSeleccionado.telefono,
                producto: pedidoSeleccionado.producto.nombre,
                emoji: pedidoSeleccionado.producto.emoji,
                total: pedidoSeleccionado.total,
                cuotas: pedidoSeleccionado.cuotas,
                montoPorCuota: pedidoSeleccionado.montoPorCuota,
                pagado: pagoEsCompleto ? pedidoSeleccionado.total : pedidoSeleccionado.montoPorCuota,
                saldo: pagoEsCompleto ? 0 : pedidoSeleccionado.total - pedidoSeleccionado.montoPorCuota
            };
            
            let ventas = JSON.parse(localStorage.getItem(STORAGE_VENTAS)) || [];
            ventas.unshift(venta);
            localStorage.setItem(STORAGE_VENTAS, JSON.stringify(ventas));
            
            // Actualizar cliente
            let clientes = JSON.parse(localStorage.getItem(STORAGE_CLIENTES)) || [];
            let cliente = clientes.find(c => c.telefono === pedidoSeleccionado.telefono);
            
            if (cliente) {
                cliente.deuda = (cliente.deuda || 0) + (venta.saldo || 0);
            } else {
                clientes.push({
                    id: Date.now(),
                    nombre: pedidoSeleccionado.cliente,
                    telefono: pedidoSeleccionado.telefono,
                    deuda: venta.saldo || 0
                });
            }
            localStorage.setItem(STORAGE_CLIENTES, JSON.stringify(clientes));
            
            // Eliminar de pedidos pendientes
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            pedidos = pedidos.filter(p => p.id !== pedidoSeleccionado.id);
            localStorage.setItem(STORAGE_PEDIDOS, JSON.stringify(pedidos));
            
            // NOTIFICAR AL CLIENTE (Simulado)
            localStorage.setItem(`confirmado_${pedidoSeleccionado.id}`, JSON.stringify(pedidoSeleccionado));
            
            cerrarModal();
            actualizarPedidos();
            actualizarVentas();
            actualizarClientes();
            toast('‚úÖ Pedido confirmado');
            localStorage.setItem('catalogo_actualizado', Date.now());
        }
        
        function rechazarPedido(id) {
            if(!confirm('¬øRechazar este pedido?')) return;
            
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            pedidos = pedidos.filter(p => p.id !== id);
            localStorage.setItem(STORAGE_PEDIDOS, JSON.stringify(pedidos));
            localStorage.setItem(`rechazado_${id}`, 'true');
            actualizarPedidos();
            toast('‚ùå Pedido rechazado');
        }

        // ========== VENTAS ==========
        function actualizarVentas() {
            let ventas = JSON.parse(localStorage.getItem(STORAGE_VENTAS)) || [];
            let container = document.getElementById('ventasLista');
            if (!container) return;
            
            if (ventas.length === 0) { 
                container.innerHTML = '<div class="list-item">No hay ventas</div>'; 
                return; 
            }
            
            let html = '';
            ventas.slice(0, 20).forEach(v => {
                let fecha = new Date(v.fecha).toLocaleDateString();
                html += `<div class="list-item">
                    <div>
                        <span style="font-weight:600;">${v.emoji} ${v.producto}</span><br>
                        <span style="font-size:12px; color:#666;">${v.cliente} ¬∑ ${fecha}</span>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-weight:700;">$${v.total.toFixed(2)}</span><br>
                        ${v.saldo > 0 ? 
                            `<span style="color:#e74c3c; font-size:12px;">Debe: $${v.saldo.toFixed(2)}</span>` : 
                            `<span style="color:#2ecc71; font-size:12px;">Pagado</span>`
                        }
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ========== CLIENTES ==========
        function actualizarClientes() {
            let clientes = JSON.parse(localStorage.getItem(STORAGE_CLIENTES)) || [];
            let container = document.getElementById('clientesLista');
            if (!container) return;
            
            if (clientes.length === 0) { 
                container.innerHTML = '<div class="list-item">No hay clientes</div>'; 
                return; 
            }
            
            let html = '';
            clientes.sort((a,b) => (b.deuda||0) - (a.deuda||0)).forEach(c => {
                html += `<div class="list-item">
                    <div>
                        <span style="font-weight:600;">${c.nombre}</span><br>
                        <span style="font-size:12px; color:#666;">üì± ${c.telefono}</span>
                    </div>
                    <div>
                        ${c.deuda > 0 ? 
                            `<span style="background:#e74c3c; color:white; padding:4px 12px; border-radius:20px; font-size:12px;">$${c.deuda.toFixed(2)}</span>` : 
                            `<span style="color:#2ecc71; font-size:12px;">Al d√≠a</span>`
                        }
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ========== NOTIFICACIONES ==========
        function actualizarNotificaciones() {
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            let pendientes = pedidos.filter(p => p.estado === 'pendiente').length;
            let badge = document.getElementById('notificationCount');
            if (badge) {
                badge.textContent = pendientes;
                badge.style.display = pendientes > 0 ? 'block' : 'none';
            }
        }
        
        function verNotificaciones() {
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
            let pendientes = pedidos.filter(p => p.estado === 'pendiente').length;
            toast(`üõí Tienes ${pendientes} pedido(s) pendiente(s)`);
            showScreen('pedidos-screen');
        }

        // ========== NOMBRE TIENDA ==========
        function cambiarNombreTienda() {
            let nombre = prompt('Nombre de tu tienda:', localStorage.getItem('businessName') || 'Mi Tienda');
            if (nombre && nombre.trim()) {
                localStorage.setItem('businessName', nombre.trim());
                document.querySelectorAll('#businessNameDisplay').forEach(el => el.textContent = nombre.trim());
                toast('‚úÖ Nombre actualizado');
            }
        }

        // ========== NAVEGACI√ìN ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            let index = { 
                'catalogo-screen': 0, 
                'pedidos-screen': 1, 
                'ventas-screen': 2, 
                'clientes-screen': 3 
            }[screenId];
            if (index !== undefined) {
                document.querySelectorAll('.nav-item')[index].classList.add('active');
            }
            
            if (screenId === 'ventas-screen') actualizarVentas();
            if (screenId === 'clientes-screen') actualizarClientes();
            if (screenId === 'catalogo-screen') actualizarCatalogo();
            if (screenId === 'pedidos-screen') actualizarPedidos();
        }

        // ========== TOAST ==========
        function toast(msg) {
            // Eliminar toasts anteriores para que no se acumulen
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            let t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Exponer funciones globalmente
        window.showScreen = showScreen;
        window.cambiarNombreTienda = cambiarNombreTienda;
        window.copiarLink = copiarLink;
        window.compartirWhatsApp = compartirWhatsApp;
        window.compartirFacebook = compartirFacebook;
        window.abrirModalProducto = abrirModalProducto;
        window.editarProducto = editarProducto;
        window.eliminarProducto = eliminarProducto;
        window.guardarProducto = guardarProducto;
        window.abrirConfirmarPedido = abrirConfirmarPedido;
        window.seleccionarPago = seleccionarPago;
        window.confirmarPedido = confirmarPedido;
        window.rechazarPedido = rechazarPedido;
        window.verNotificaciones = verNotificaciones;
        window.actualizarLink = actualizarLink;
        window.cerrarModal = cerrarModal;
        window.cerrarModalFuera = cerrarModalFuera;
    </script>
</body>
</html>
