<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Mi Negocio ¬∑ Administrador</title>
    <style>
        /* ===== ESTILOS (mant√©n los que ya tienes, son perfectos) ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f5f7fb; display: flex; flex-direction: column; align-items: center; }
        .app-container { max-width: 480px; width: 100%; background: white; min-height: 100vh; position: relative; }
        .screen { display: none; padding: 16px 16px 80px; }
        .active-screen { display: block; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; border-bottom: 1px solid #f0f2f5; position: sticky; top: 0; z-index: 10; }
        .logo-area { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .logo-icon { background: linear-gradient(145deg, #1a5cff, #0a3eb0); color: white; width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .header-actions { display: flex; gap: 16px; }
        .icon-btn { font-size: 20px; cursor: pointer; position: relative; }
        .notification-badge { position: absolute; top: -4px; right: -4px; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; }
        .welcome-card { background: linear-gradient(135deg, #f2f6ff, #ffffff); border-radius: 24px; padding: 20px; margin-bottom: 24px; border: 1px solid #e9ecf0; }
        .business-name { font-size: 20px; font-weight: 700; color: #0a1e3c; }
        .stats-row { display: flex; justify-content: space-between; background: white; padding: 16px 12px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); margin-top: 8px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-label { font-size: 12px; color: #6f7b8a; }
        .stat-number { font-size: 20px; font-weight: 700; color: #0b1b33; }
        .modules-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .module-item { background: #f8fafc; border-radius: 20px; padding: 20px 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 1px solid #e9ecf0; }
        .module-icon { font-size: 32px; margin-bottom: 8px; }
        .module-item span { font-size: 13px; font-weight: 600; color: #0a1e3c; }
        .btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #1a5cff, #0a3eb0); color: white; border: none; border-radius: 16px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .list-card { background: white; border-radius: 20px; padding: 12px; border: 1px solid #f0f2f5; margin-bottom: 16px; }
        .list-item { display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid #f5f7fb; }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; border-top: 1px solid #e9ecf0; display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; cursor: pointer; color: #8a92a3; }
        .nav-item.active { color: #1a5cff; }
        .nav-icon { font-size: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 24px; max-width: 400px; width: 90%; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e9ecf0; border-radius: 12px; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; z-index: 2000; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ===== HEADER ===== -->
        <div class="app-header">
            <div class="logo-area" onclick="openEditNameModal()">
                <div class="logo-icon">üè™</div>
                <div class="logo-text" id="businessNameDisplay">Mi Tienda</div>
            </div>
            <div class="header-actions">
                <span class="icon-btn" onclick="openNotificationsModal()">
                    üîî
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </span>
                <span class="icon-btn" onclick="openSettingsModal()">‚öôÔ∏è</span>
            </div>
        </div>

        <!-- ===== PANTALLA HOME ===== -->
        <div id="home-screen" class="screen active-screen">
            <div class="welcome-card">
                <div class="business-name" id="businessNameHome">Mi Tienda</div>
                <div class="greeting">¬°Administra tus pedidos y ventas! üëã</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Ventas hoy</div>
                        <div class="stat-number" id="ventasHoy">$0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Pedidos</div>
                        <div class="stat-number" id="pedidosPendientes">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Productos</div>
                        <div class="stat-number" id="totalProductos">2</div>
                    </div>
                </div>
            </div>
            <div class="modules-grid" id="menuModulos">
                <!-- Se llena con JavaScript -->
            </div>
        </div>

        <!-- ===== PANTALLA DE PEDIDOS (NUEVA) ===== -->
        <div id="pedidos-screen" class="screen">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <span style="font-size: 28px; cursor: pointer;" onclick="goBack()">‚Üê</span>
                <h1 style="font-size: 24px; font-weight: 700;">üõí Pedidos</h1>
            </div>
            <div id="pedidosLista" class="list-card">
                <div class="list-item">Cargando pedidos...</div>
            </div>
        </div>

        <!-- ===== RESTO DE PANTALLAS (ventas, inventario, etc) ===== -->
        <div id="ventas-screen" class="screen">[TU CONTENIDO DE VENTAS]</div>
        <div id="inventario-screen" class="screen">[TU CONTENIDO DE INVENTARIO]</div>
        <div id="catalogo-screen" class="screen">[TU CONTENIDO DE CAT√ÅLOGO]</div>
        <div id="clientes-screen" class="screen">[TU CONTENIDO DE CLIENTES]</div>
        <div id="caja-screen" class="screen">[TU CONTENIDO DE CAJA]</div>
        <div id="config-screen" class="screen">[TU CONTENIDO DE CONFIGURACI√ìN]</div>

        <!-- ===== BARRA DE NAVEGACI√ìN ===== -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('home-screen')">üè† Inicio</div>
            <div class="nav-item" onclick="showScreen('pedidos-screen')">üõí Pedidos</div>
            <div class="nav-item" onclick="showScreen('catalogo-screen')">üì± Cat√°logo</div>
            <div class="nav-item" onclick="showScreen('ventas-screen')">üí∞ Ventas</div>
            <div class="nav-item" onclick="showScreen('config-screen')">‚öôÔ∏è M√°s</div>
        </div>
    </div>

    <script>
        // ===== üöÄ NUEVO: GESTI√ìN COMPLETA DE PEDIDOS =====
        const STORAGE_KEY = 'catalogo_tienda';
        const PEDIDOS_KEY = 'pedidos_pendientes';
        const CONFIRMADOS_KEY = 'pedidos_confirmados';

        // ===== 1. INICIALIZAR TODO =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Administrador iniciado');
            inicializarModulos();
            cargarPedidos();
            sincronizarConCatalogo();
            
            // Escuchar nuevos pedidos en tiempo real
            window.addEventListener('storage', function(e) {
                if (e.key === PEDIDOS_KEY || e.key === 'nuevo_pedido') {
                    console.log('üì¶ Nuevo pedido detectado');
                    cargarPedidos();
                    actualizarContador();
                    showToast('üõí Nuevo pedido recibido');
                }
            });
        });

        // ===== 2. CONSTRUIR MEN√ö PRINCIPAL =====
        function inicializarModulos() {
            const menu = document.getElementById('menuModulos');
            if (menu) {
                menu.innerHTML = `
                    <div class="module-item" onclick="showScreen('pedidos-screen')">
                        <div class="module-icon">üõí</div>
                        <span>Pedidos</span>
                    </div>
                    <div class="module-item" onclick="showScreen('catalogo-screen')">
                        <div class="module-icon">üì±</div>
                        <span>Cat√°logo</span>
                    </div>
                    <div class="module-item" onclick="showScreen('ventas-screen')">
                        <div class="module-icon">üí∞</div>
                        <span>Ventas</span>
                    </div>
                    <div class="module-item" onclick="showScreen('inventario-screen')">
                        <div class="module-icon">üì¶</div>
                        <span>Inventario</span>
                    </div>
                    <div class="module-item" onclick="showScreen('clientes-screen')">
                        <div class="module-icon">üë•</div>
                        <span>Clientes</span>
                    </div>
                    <div class="module-item" onclick="showScreen('caja-screen')">
                        <div class="module-icon">üíµ</div>
                        <span>Caja</span>
                    </div>
                `;
            }
        }

        // ===== 3. CARGAR Y MOSTRAR PEDIDOS =====
        function cargarPedidos() {
            const container = document.getElementById('pedidosLista');
            if (!container) return;
            
            const pedidos = JSON.parse(localStorage.getItem(PEDIDOS_KEY) || '[]');
            const pendientes = pedidos.filter(p => p.estado === 'pendiente');
            
            if (pendientes.length === 0) {
                container.innerHTML = '<div class="list-item">‚úÖ No hay pedidos pendientes</div>';
                document.getElementById('pedidosPendientes').innerHTML = '0';
                return;
            }
            
            let html = '';
            pendientes.forEach((pedido, index) => {
                const fecha = new Date(pedido.fecha).toLocaleString();
                html += `
                    <div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 2px solid #f39c12;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-weight: 700;">${pedido.producto.emoji} ${pedido.producto.name}</span>
                            <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">NUEVO</span>
                        </div>
                        <div style="font-size: 14px; margin-bottom: 8px;">
                            üë§ ${pedido.cliente}<br>
                            üì± ${pedido.telefono}
                        </div>
                        <div style="background: #f2f6ff; padding: 12px; border-radius: 12px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>üí∞ Total:</span>
                                <span style="font-weight: 700;">$${pedido.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>üí≥ Pago:</span>
                                <span>${pedido.cuotas} cuota(s) ¬∑ $${pedido.montoPorCuota.toFixed(2)} c/u</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success" style="flex: 1;" onclick="confirmarPedido(${pedido.id})">
                                ‚úÖ Confirmar
                            </button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="rechazarPedido(${pedido.id})">
                                ‚ùå Rechazar
                            </button>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; color: #6f7b8a;">
                            üìÖ ${fecha}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('pedidosPendientes').innerHTML = pendientes.length;
            actualizarContador();
        }

        // ===== 4. CONFIRMAR PEDIDO =====
        function confirmarPedido(pedidoId) {
            const pedidos = JSON.parse(localStorage.getItem(PEDIDOS_KEY) || '[]');
            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
            
            if (pedidoIndex === -1) {
                showToast('‚ùå Pedido no encontrado');
                return;
            }
            
            const pedido = pedidos[pedidoIndex];
            
            // Verificar stock
            const catalogo = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const producto = catalogo.find(p => p.id === pedido.producto.id);
            
            if (!producto || producto.stock < 1) {
                showToast('‚ùå Stock insuficiente');
                return;
            }
            
            // Restar stock
            producto.stock -= 1;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(catalogo));
            
            // Actualizar estado del pedido
            pedido.estado = 'aceptado';
            pedido.fechaConfirmacion = new Date().toISOString();
            
            // Mover a confirmados
            let confirmados = JSON.parse(localStorage.getItem(CONFIRMADOS_KEY) || '[]');
            confirmados.unshift(pedido);
            localStorage.setItem(CONFIRMADOS_KEY, JSON.stringify(confirmados));
            
            // Eliminar de pendientes
            pedidos.splice(pedidoIndex, 1);
            localStorage.setItem(PEDIDOS_KEY, JSON.stringify(pedidos));
            
            // NOTIFICAR AL CLIENTE (clave: esto actualiza el cat√°logo del cliente)
            localStorage.setItem('confirmado_' + pedidoId, JSON.stringify(pedido));
            localStorage.removeItem('nuevo_pedido_' + pedidoId);
            
            showToast('‚úÖ Pedido confirmado');
            cargarPedidos();
            actualizarContador();
            
            // Registrar venta autom√°tica
            registrarVentaDesdePedido(pedido);
        }

        // ===== 5. RECHAZAR PEDIDO =====
        function rechazarPedido(pedidoId) {
            const pedidos = JSON.parse(localStorage.getItem(PEDIDOS_KEY) || '[]');
            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
            
            if (pedidoIndex === -1) return;
            
            const pedido = pedidos[pedidoIndex];
            pedido.estado = 'rechazado';
            
            // Guardar en rechazados
            let rechazados = JSON.parse(localStorage.getItem('pedidos_rechazados') || '[]');
            rechazados.unshift(pedido);
            localStorage.setItem('pedidos_rechazados', JSON.stringify(rechazados));
            
            // Eliminar de pendientes
            pedidos.splice(pedidoIndex, 1);
            localStorage.setItem(PEDIDOS_KEY, JSON.stringify(pedidos));
            
            // Notificar rechazo al cliente
            localStorage.setItem('rechazado_' + pedidoId, JSON.stringify(pedido));
            
            showToast('‚ùå Pedido rechazado');
            cargarPedidos();
            actualizarContador();
        }

        // ===== 6. REGISTRAR VENTA AUTOM√ÅTICA =====
        function registrarVentaDesdePedido(pedido) {
            const venta = {
                id: Date.now(),
                factura: 'P-' + String(Date.now()).slice(-4),
                fecha: new Date().toISOString(),
                cliente: pedido.cliente,
                producto: pedido.producto.name,
                emoji: pedido.producto.emoji,
                cantidad: 1,
                total: pedido.total,
                metodo: 'Pedido ' + pedido.cuotas + ' cuota(s)'
            };
            
            let ventas = JSON.parse(localStorage.getItem('ventas') || '[]');
            ventas.unshift(venta);
            localStorage.setItem('ventas', JSON.stringify(ventas));
        }

        // ===== 7. SINCRONIZAR CON EL CAT√ÅLOGO =====
        function sincronizarConCatalogo() {
            // Cada 5 segundos, verificar si hay nuevos pedidos
            setInterval(() => {
                const notificacion = localStorage.getItem('notificar_pedido');
                if (notificacion === 'true') {
                    cargarPedidos();
                    localStorage.removeItem('notificar_pedido');
                }
            }, 3000);
        }

        // ===== 8. ACTUALIZAR CONTADOR DE NOTIFICACIONES =====
        function actualizarContador() {
            const pedidos = JSON.parse(localStorage.getItem(PEDIDOS_KEY) || '[]');
            const pendientes = pedidos.filter(p => p.estado === 'pendiente').length;
            
            const badge = document.getElementById('notificationCount');
            if (badge) {
                badge.textContent = pendientes;
                badge.style.display = pendientes > 0 ? 'block' : 'none';
            }
        }

        // ===== 9. NAVEGACI√ìN =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (screenId === 'home-screen') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if (screenId === 'pedidos-screen') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if (screenId === 'catalogo-screen') document.querySelectorAll('.nav-item')[2].classList.add('active');
            if (screenId === 'ventas-screen') document.querySelectorAll('.nav-item')[3].classList.add('active');
            if (screenId === 'config-screen') document.querySelectorAll('.nav-item')[4].classList.add('active');
        }

        function goBack() { showScreen('home-screen'); }
        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===== 10. FUNCIONES PARA MODALES (tus originales) =====
        function openEditNameModal() { /* mant√©n tu c√≥digo original */ }
        function closeEditNameModal() { /* mant√©n tu c√≥digo original */ }
        function saveBusinessName() { /* mant√©n tu c√≥digo original */ }
        function openSettingsModal() { /* mant√©n tu c√≥digo original */ }
        function closeSettingsModal() { /* mant√©n tu c√≥digo original */ }
        function saveSettings() { /* mant√©n tu c√≥digo original */ }
        function openNotificationsModal() { /* mant√©n tu c√≥digo original */ }
        function closeNotificationsModal() { /* mant√©n tu c√≥digo original */ }

        // Exponer funciones globalmente
        window.showScreen = showScreen;
        window.goBack = goBack;
        window.confirmarPedido = confirmarPedido;
        window.rechazarPedido = rechazarPedido;
        window.openEditNameModal = openEditNameModal;
        window.closeEditNameModal = closeEditNameModal;
        window.saveBusinessName = saveBusinessName;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.saveSettings = saveSettings;
        window.openNotificationsModal = openNotificationsModal;
        window.closeNotificationsModal = closeNotificationsModal;
    </script>
</body>
</html>
