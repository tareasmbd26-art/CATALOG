<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Mi Tienda ¬∑ Cat√°logo</title>
    <style>
        /* (mismos estilos, ya funcionan) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f5f7fb; display: flex; flex-direction: column; align-items: center; padding: 16px; }
        .container { max-width: 480px; width: 100%; background: white; border-radius: 24px; padding: 20px; }
        .header { text-align: center; margin-bottom: 24px; }
        .business-name { font-size: 24px; font-weight: 700; color: #0a1e3c; }
        .product { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid #e9ecf0; display: flex; gap: 16px; }
        .product-image { width: 80px; height: 80px; background: #f0f2f5; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .product-info { flex: 1; }
        .product-name { font-weight: 600; font-size: 16px; }
        .product-price { font-size: 20px; font-weight: 700; color: #1a5cff; }
        .btn { width: 100%; padding: 14px; background: #1a5cff; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 24px; max-width: 400px; width: 90%; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e9ecf0; border-radius: 12px; margin-bottom: 16px; }
        .cuota-option { display: flex; align-items: center; gap: 8px; padding: 12px; border: 1px solid #e9ecf0; border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .cuota-option.selected { border-color: #1a5cff; background: #f2f6ff; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; z-index: 2000; }
        .estado-box { background: #f2f6ff; border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 2px solid #1a5cff; }
        .pendiente { color: #f39c12; font-weight: 700; }
        .confirmado { color: #2ecc71; font-weight: 700; }
        .empty-message { text-align: center; padding: 40px; color: #999; background: #f9f9fb; border-radius: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="business-name" id="businessName">Mi Tienda</div>
            <div style="color: #666;">üõçÔ∏è Selecciona y solicita tu pedido</div>
        </div>

        <div id="estadoPedido" style="display: none;"></div>
        <div id="productosLista"></div>
    </div>

    <!-- MODAL SOLICITUD -->
    <div id="pedidoModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 16px;">üì¶ Solicitar producto</h2>
            <div id="resumenProducto" style="background: #f2f6ff; padding: 16px; border-radius: 12px; margin-bottom: 16px;"></div>
            <input type="text" id="clienteNombre" class="form-input" placeholder="Tu nombre">
            <input type="text" id="clienteTelefono" class="form-input" placeholder="Tu WhatsApp">
            <div style="font-weight: 600; margin-bottom: 8px;">üí∞ ¬øC√≥mo deseas pagar? (M√°x. 2 cuotas)</div>
            <div class="cuota-option selected" id="pagoCompleto" onclick="seleccionarCuotas(1)">
                <span style="font-size: 20px;">‚úÖ</span>
                <div style="flex:1;">Pago completo</div>
                <div style="font-weight:700;" id="totalCompleto">$0.00</div>
            </div>
            <div class="cuota-option" id="pago2Cuotas" onclick="seleccionarCuotas(2)">
                <span style="font-size: 20px;">üîÑ</span>
                <div style="flex:1;">2 cuotas</div>
                <div style="font-weight:700;" id="total2Cuotas">$0.00</div>
            </div>
            <button class="btn" onclick="enviarPedido()" style="margin-top: 16px;">üì® Solicitar pedido</button>
        </div>
    </div>

    <!-- MODAL CONFIRMACI√ìN -->
    <div id="confirmacionModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;" id="confirmacionEmoji">‚úÖ</div>
            <h2 style="margin-bottom: 8px;" id="confirmacionTitulo">¬°Pedido confirmado!</h2>
            <p style="color: #666; margin-bottom: 24px;" id="confirmacionMensaje"></p>
            <button class="btn" onclick="cerrarConfirmacion()">Aceptar</button>
        </div>
    </div>

    <script>
        // ========== CAT√ÅLOGO P√öBLICO - CORREGIDO ==========
        const STORAGE_PRODUCTOS = 'catalogo_productos';
        const STORAGE_PEDIDOS = 'pedidos_pendientes';
        
        let productos = [];
        let productoSeleccionado = null;
        let cuotasSeleccionadas = 1;

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõçÔ∏è Cat√°logo iniciado');
            cargarProductos();
            
            let nombre = localStorage.getItem('businessName') || 'Mi Tienda';
            document.getElementById('businessName').textContent = nombre;
            
            // Escuchar cambios en localStorage
            window.addEventListener('storage', function(e) {
                console.log('üì° storage event en tienda, key:', e.key);
                if (e.key === STORAGE_PRODUCTOS) {
                    console.log('üì¶ Cat√°logo actualizado, recargando productos...');
                    cargarProductos();
                }
                if (e.key && e.key.startsWith('confirmado_') && e.newValue) {
                    try {
                        let pedido = JSON.parse(e.newValue);
                        console.log('‚úÖ Pedido confirmado recibido:', pedido);
                        mostrarConfirmacion(pedido);
                        localStorage.removeItem(e.key);
                    } catch (error) {
                        console.warn('Error al parsear confirmaci√≥n', error);
                    }
                }
                if (e.key && e.key.startsWith('rechazado_') && e.newValue) {
                    console.log('‚ùå Pedido rechazado');
                    mostrarRechazo();
                    localStorage.removeItem(e.key);
                }
            });
            
            verificarPedidoPendiente();
        });

        // ========== FUNCIONES DE PRODUCTOS ==========
        function cargarProductos() {
            let stored = localStorage.getItem(STORAGE_PRODUCTOS);
            if (stored) {
                try {
                    productos = JSON.parse(stored);
                } catch(e) {
                    console.error('Error al parsear productos', e);
                    productos = [];
                }
            } else {
                productos = [];
            }
            renderizarProductos();
        }

        function renderizarProductos() {
            let container = document.getElementById('productosLista');
            if (!container) return;
            
            if (productos.length === 0) {
                container.innerHTML = '<div class="empty-message">üì≠ No hay productos disponibles</div>';
                return;
            }
            
            let html = '';
            productos.forEach(p => {
                const precio = Number(p.precio) || 0;
                const stock = Number(p.stock) || 0;
                const emoji = p.emoji || 'üì¶';
                const descripcion = p.descripcion || '';
                
                if (stock > 0) {
                    html += `<div class="product">
                        <div class="product-image">${emoji}</div>
                        <div class="product-info">
                            <div class="product-name">${p.nombre}</div>
                            <div style="color:#666; font-size:13px;">${descripcion}</div>
                            <div class="product-price">$${precio.toFixed(2)}</div>
                            <div style="font-size:12px; color:#2ecc71;">‚úì ${stock} disponibles</div>
                            <button class="btn" onclick="abrirModal(${p.id})">üì¶ Solicitar</button>
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }

        // ========== SOLICITUD DE PEDIDO ==========
        function abrirModal(id) {
            productoSeleccionado = productos.find(p => p.id === id);
            if (!productoSeleccionado) return;
            
            const precio = Number(productoSeleccionado.precio) || 0;
            const emoji = productoSeleccionado.emoji || 'üì¶';
            
            document.getElementById('resumenProducto').innerHTML = `
                <div style="display:flex; gap:12px;">
                    <div style="font-size:32px;">${emoji}</div>
                    <div>
                        <div style="font-weight:600;">${productoSeleccionado.nombre}</div>
                        <div style="color:#666;">$${precio.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('totalCompleto').innerHTML = `$${precio.toFixed(2)}`;
            document.getElementById('total2Cuotas').innerHTML = `$${(precio/2).toFixed(2)} c/u`;
            
            cuotasSeleccionadas = 1;
            document.querySelectorAll('.cuota-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('pagoCompleto').classList.add('selected');
            
            document.getElementById('pedidoModal').classList.add('active');
        }

        function seleccionarCuotas(num) {
            cuotasSeleccionadas = num;
            document.querySelectorAll('.cuota-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(num === 1 ? 'pagoCompleto' : 'pago2Cuotas').classList.add('selected');
        }

        function enviarPedido() {
            let nombre = document.getElementById('clienteNombre').value.trim();
            let telefono = document.getElementById('clienteTelefono').value.trim();
            
            if (!nombre || !telefono) { 
                alert('‚ö†Ô∏è Completa tus datos'); 
                return; 
            }
            if (!productoSeleccionado) return;
            
            const precio = Number(productoSeleccionado.precio) || 0;
            
            let pedido = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                cliente: nombre,
                telefono: telefono,
                producto: {
                    id: productoSeleccionado.id,
                    nombre: productoSeleccionado.nombre,
                    precio: precio,
                    emoji: productoSeleccionado.emoji || 'üì¶'
                },
                total: precio,
                cuotas: cuotasSeleccionadas,
                montoPorCuota: precio / cuotasSeleccionadas,
                estado: 'pendiente'
            };
            
            let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS) || '[]');
            pedidos.unshift(pedido);
            localStorage.setItem(STORAGE_PEDIDOS, JSON.stringify(pedidos));
            localStorage.setItem('nuevo_pedido', 'true');
            localStorage.setItem(`mi_pedido_${pedido.id}`, JSON.stringify(pedido));
            
            document.getElementById('pedidoModal').classList.remove('active');
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            
            mostrarEstadoPendiente(pedido);
            toast('‚úÖ Solicitud enviada. Espera confirmaci√≥n.');
        }

        // ========== ESTADOS Y CONFIRMACIONES ==========
        function mostrarEstadoPendiente(pedido) {
            let div = document.getElementById('estadoPedido');
            div.style.display = 'block';
            div.innerHTML = `
                <div class="estado-box">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:20px;">‚è≥</span>
                        <span class="pendiente">Pendiente de confirmaci√≥n</span>
                    </div>
                    <div style="margin-top:12px;">
                        <strong>${pedido.producto.emoji} ${pedido.producto.nombre}</strong><br>
                        <span style="color:#666;">Total: $${pedido.total.toFixed(2)} ¬∑ ${pedido.cuotas} cuota(s)</span>
                    </div>
                </div>
            `;
        }

        function mostrarConfirmacion(pedido) {
            let modal = document.getElementById('confirmacionModal');
            let emoji = document.getElementById('confirmacionEmoji');
            let titulo = document.getElementById('confirmacionTitulo');
            let mensaje = document.getElementById('confirmacionMensaje');
            
            if (pedido.pagoCompleto) {
                emoji.innerHTML = '‚úÖ';
                titulo.innerHTML = '¬°Pedido confirmado!';
                mensaje.innerHTML = `Tu pedido de <strong>${pedido.producto.emoji} ${pedido.producto.nombre}</strong> ha sido ACEPTADO.<br><br>üí∞ Total: $${pedido.total.toFixed(2)}<br>üí≥ Pago: Completo<br><br>El vendedor te contactar√°.`;
            } else {
                emoji.innerHTML = 'üîÑ';
                titulo.innerHTML = '¬°Pedido confirmado!';
                mensaje.innerHTML = `Tu pedido de <strong>${pedido.producto.emoji} ${pedido.producto.nombre}</strong> ha sido ACEPTADO.<br><br>üí∞ Total: $${pedido.total.toFixed(2)}<br>üí≥ Pago: 2 cuotas de $${pedido.montoPorCuota.toFixed(2)}<br><br>El vendedor te contactar√°.`;
            }
            
            modal.classList.add('active');
            document.getElementById('estadoPedido').style.display = 'none';
        }

        function mostrarRechazo() {
            let modal = document.getElementById('confirmacionModal');
            document.getElementById('confirmacionEmoji').innerHTML = '‚ùå';
            document.getElementById('confirmacionTitulo').innerHTML = 'Pedido no disponible';
            document.getElementById('confirmacionMensaje').innerHTML = 'Lo sentimos, tu pedido no pudo ser confirmado. Intenta con otro producto.';
            modal.classList.add('active');
            document.getElementById('estadoPedido').style.display = 'none';
        }

        function verificarPedidoPendiente() {
            for (let i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                if (key && key.startsWith('mi_pedido_')) {
                    try {
                        let pedido = JSON.parse(localStorage.getItem(key));
                        let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS) || '[]');
                        let pendiente = pedidos.find(p => p.id === pedido.id && p.estado === 'pendiente');
                        if (pendiente) mostrarEstadoPendiente(pendiente);
                    } catch(e) {
                        console.warn('Error verificando pedido pendiente', e);
                    }
                }
            }
        }

        function cerrarConfirmacion() {
            document.getElementById('confirmacionModal').classList.remove('active');
        }

        function toast(msg) {
            let t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Exponer funciones globales
        window.abrirModal = abrirModal;
        window.seleccionarCuotas = seleccionarCuotas;
        window.enviarPedido = enviarPedido;
        window.cerrarConfirmacion = cerrarConfirmacion;
    </script>
</body>
</html>